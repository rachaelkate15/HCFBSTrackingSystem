<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.6.22/css/uikit.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Lexend+Deca:wght@100..900&display=swap" rel="stylesheet">
    <link rel = "stylesheet" type = "text/css" href = "assets/css/uikitMods.css">
</head>
<body>

<div class="uk-section uk-flex uk-flex-middle uk-animation-fade" uk-height-viewport>
    <div class="uk-width-1-1">
        <div class="uk-container">
            <div class="uk-grid-margin uk-grid uk-grid-stack" uk-grid>
                <div class="uk-width-1-1@m">
                    <div class="uk-margin uk-width-large uk-margin-auto uk-card uk-card-default uk-card-body uk-box-shadow-large">
                        <img src="assets/images/FB_HUMBOLDT_LOGO_RGB_1COLOR_GREEN.jpg" alt="Humboldt Logo" class="uk-margin uk-margin-auto">
                        <form id="loginForm">
                            <div class="uk-margin">
                                <div class="uk-inline uk-width-1-1">
                                    <span class="uk-form-icon" uk-icon="icon: user"></span>
                                    <input class="uk-input" type="email" id="email" placeholder="Email" required="required">
                                </div>
                            </div>
                            <div class="uk-margin">
                                <div class="uk-inline uk-width-1-1">
                                    <span class="uk-form-icon" uk-icon="icon: lock"></span>
                                    <input class="uk-input" type="password" id="password" placeholder="Password" required="required">
                                </div>
                            </div>
                            <div class="uk-margin">
                                <button type="submit" class="uk-button uk-width-1-1">Login</button>
                            </div>
                            <div id="error-message" class="uk-text-danger uk-text-center" style="display: none;"></div>

                            <div class="uk-text-center" style="font-weight:300;">
                                <span style="margin-right: 5px;width: 15px" class="uk-icon" uk-icon="icon: info"></span>
                                <a href="adminLogin.html">Admin Login</a>
                                <hr style="margin:7.5px;border-width:2.5px">
                                Don't have an account? 
                                <a href="signup.html">Sign up</a>
                            </div>   
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.6.22/js/uikit.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.6.22/js/uikit-icons.min.js"></script>
<script src="assets/js/api.js"></script>
<script>
  document.getElementById('loginForm').addEventListener('submit', async (event) => {
    event.preventDefault();
    
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const errorMessage = document.getElementById('error-message');
    
    try {
      // Step 1: Authenticate with Firebase
      const response = await fetch('/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ email, password })
      });
      
      const result = await response.json();
      
      if (response.ok) {
        // Store authentication data
        localStorage.setItem('token', result.token);
        localStorage.setItem('userEmail', result.email);
        localStorage.setItem('uid', result.uid);
        
        // Step 2: Fetch user profile from MongoDB
        try {
          const fetchProfileResponse = await fetch(`/api/applicants?email=${encodeURIComponent(email)}`, {
            headers: {
              'Authorization': `Bearer ${result.token}`
            }
          });
          
          if (fetchProfileResponse.ok) {
            const profiles = await fetchProfileResponse.json();
            
            if (profiles && profiles.length > 0) {
              // Store basic profile data
              localStorage.setItem('userId', profiles[0]._id);
              localStorage.setItem('firstName', profiles[0].firstName);
              localStorage.setItem('lastName', profiles[0].lastName);
              
              console.log('Profile loaded from MongoDB');
            } else {
              console.warn('No profile found in MongoDB');
            }
          }
          
          // Redirect to dashboard or home page
          window.location.href = '/dashboard.html';
        } catch (profileError) {
          console.error('Error fetching profile:', profileError);
          // Still redirect to dashboard, but there might be incomplete profile data
          window.location.href = '/dashboard.html';
        }
      } else {
        errorMessage.textContent = result.error || 'Login failed. Please try again.';
        errorMessage.style.display = 'block';
      }
    } catch (error) {
      errorMessage.textContent = 'An error occurred. Please try again later.';
      errorMessage.style.display = 'block';
      console.error('Error:', error);
    }
  });
  
  // Check for registration success message
  document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('registered') === 'true') {
      const errorMessage = document.getElementById('error-message');
      errorMessage.textContent = 'Registration successful! Please login.';
      errorMessage.style.display = 'block';
      errorMessage.classList.remove('uk-text-danger');
      errorMessage.classList.add('uk-text-success');
    }
  });
</script>
</body>
</html>